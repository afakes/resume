<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script>

		/**
         * https://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript
		 * @param name
		 * @param url
		 * @returns {*}
		 */
		function getParameterByName(name, url) {
			if (!url) url = window.location.href;
			name = name.replace(/[\[\]]/g, '\\$&');
			var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
				results = regex.exec(url);
			if (!results) return null;
			if (!results[2]) return '';
			return decodeURIComponent(results[2].replace(/\+/g, ' '));
		}

		function fromTemplate(templateSelector, data) {
			let template = document.querySelector(templateSelector).innerHTML;
			let populate = eval(`\n (data) => { try { return \` ${template} \`; }  catch(e) { console.log(\`TEMPLATE FAILED: ${templateSelector} \` , e); return ""; } }\n `);
			return populate(data);
        }

        function sourceMissing() {
			document.getElementsByTagName("body")[0].innerHTML = "expects URL parameter url<br>e.g. http://..../?url=https://raw.githubusercontent.com/afakes/resume/master/resume.json";
        }

        function getSourceData(templateID = "#body") {

			let dataSourceURL = getParameterByName('url');
            if (dataSourceURL == null) { sourceMissing(); return; }

            fetch(dataSourceURL)
                .then(
                    function(response) {
                        if (response.status === 200) {
                            response.json().then(
                                (data) => {
									document.getElementsByTagName("body")[0].innerHTML = fromTemplate(templateID, data);
								}
                            );
                        } else {
							document.getElementsByTagName("body")[0].innerHTML = `<pre>FAILED to load data from ${dataSourceURL}</pre>`;
                        }
                    }
                )
                .catch(
                	(err) => {
						document.getElementsByTagName("body")[0].innerHTML = `<pre>${err.toString()}</pre>`;
					}
                );
        }

        function pre(data = {}, indent = 4) {
			return "<pre>" + JSON.stringify(data, null, indent) + "</pre>";
        }

        function rows(templateID, data) {

			console.log("data = ",data);

			let result = "";
			if (Array.isArray(data)) {
				data.forEach( (element,key) => { result += fromTemplate(templateID, element, key ) + "\n"; } );
            } else if (typeof data === "object") {
				Object.keys(data).forEach( (key) => { result += fromTemplate(templateID, {"key": key, "value": data[key] }) + "\n"; } );
			} else {
				result = "row source unknown";
            }
			return result;
        }
    </script>
</head>

<body onload="getSourceData()">

</body>

<template id="body">
    <h1>${data.name}</h1>
    <ul>
        <li>${data.email}</li>
        <li>${data.phone}</li>
    </ul>
    <p>${data.about}</p>

    <h1>EDUCATION</h1>
    <hr>
    ${rows('#education', data.education)}
    <hr>

    <h1>${data.academic.title}</h1>
    <ul>
        ${pre(data.academic)}
    </ul>

    <h1>presence</h1>
    <ul>${rows('#presence', data.presence)}</ul>

</template>

<template id="education">
    <p><span style="font-family: monospace">${data.date}</span> - ${data.name}</p>
</template>
<template id="presence">
    <li><span style="font-family: monospace">${data.key}</span> - ${data.value}</li>
</template>
<template id="publications">
    <li><span style="font-family: monospace">${data}</span></li>
</template>
</html>
